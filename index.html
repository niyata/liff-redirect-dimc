<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LIFF Redirect Portal</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; background: #f5f5f5; }
    h2 { color: #333; }
    button { margin: 0.2rem; padding: 0.5rem 1rem; }
    .link-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      width: 90%; max-width: 400px;
    }
    label { display: block; margin-top: 0.5rem; }
    input, textarea { width: 100%; padding: 0.4rem; margin-top: 0.2rem; }
  </style>
</head>
<body>
  <h2>üîó Redirect Portal</h2>
  <div id="link-list"></div>
  <button onclick="showForm()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡∏°‡πà</button>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="form-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå</h3>
      <input type="hidden" id="link-id">
      <label>‡∏ä‡∏∑‡πà‡∏≠:</label>
      <input type="text" id="link-title">
      <label>URL:</label>
      <input type="text" id="link-url">
      <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</label>
      <textarea id="link-description"></textarea>
      <button onclick="submitForm()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button onclick="closeForm()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <script>
    const API_URL = 'YOUR_DEPLOYED_SCRIPT_URL'; // <= Replace this with your Apps Script Web App URL

    async function init() {
      await liff.init({ liffId: 'YOUR_LIFF_ID' }); // <= Replace with your LIFF ID
      fetchLinks();
    }

    async function fetchLinks() {
      const res = await fetch(`${API_URL}?action=list`);
      const links = await res.json();
      const container = document.getElementById('link-list');
      container.innerHTML = '';
      links.forEach(link => {
        const div = document.createElement('div');
        div.className = 'link-card';
        div.innerHTML = `
          <b>${link.Title}</b><br>
          <small>${link.Description}</small><br>
          <button onclick="openExternal('${link.URL}')">üåê ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
          <button onclick="editLink(${link.ID}, '${link.Title}', '${link.URL}', '${link.Description}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button onclick="deleteLink(${link.ID})">üóëÔ∏è ‡∏•‡∏ö</button>
        `;
        container.appendChild(div);
      });
    }

    function openExternal(url) {
      liff.openWindow({ url, external: true });
    }

    function showForm(id = null) {
      document.getElementById('modal').style.display = 'flex';
      if (!id) {
        document.getElementById('form-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå';
        document.getElementById('link-id').value = '';
        document.getElementById('link-title').value = '';
        document.getElementById('link-url').value = '';
        document.getElementById('link-description').value = '';
      }
    }

    function closeForm() {
      document.getElementById('modal').style.display = 'none';
    }

    function editLink(id, title, url, description) {
      showForm(id);
      document.getElementById('form-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå';
      document.getElementById('link-id').value = id;
      document.getElementById('link-title').value = title;
      document.getElementById('link-url').value = url;
      document.getElementById('link-description').value = description;
    }

    async function submitForm() {
      const id = document.getElementById('link-id').value;
      const title = document.getElementById('link-title').value;
      const url = document.getElementById('link-url').value;
      const description = document.getElementById('link-description').value;

      const payload = {
        action: id ? 'update' : 'create',
        id: Number(id),
        title,
        url,
        description
      };

      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });

      closeForm();
      fetchLinks();
    }

    async function deleteLink(id) {
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ?')) return;
      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'delete', id }),
        headers: { 'Content-Type': 'application/json' }
      });
      fetchLinks();
    }

    init();
  </script>
</body>
</html>
